<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Photobalm AI</title>
<style>
  :root{--ink:#0f172a;--ink-soft:#4b5563;--nav:#122647;--cream:#f7f3ea;--btn:#f6c10e;--border:#e5e7eb;--panel:#fff}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--cream)}
  header{background:var(--nav);color:#fff;padding:28px 16px;text-align:center}
  header h1{margin:0 0 6px;font-size:34px}
  header p{margin:0;color:#d9e1f2}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(15,23,42,.08);padding:18px}
  .card h2{margin:4px 0 10px}
  .row{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap}
  .col{flex:1 1 320px}
  .drop{display:flex;align-items:center;justify-content:center;text-align:center;border:2px dashed #cbd5e1;border-radius:14px;background:#fafaf9;padding:22px;cursor:pointer}
  .drop input{display:none}
  label{font-weight:700;margin:10px 0 6px;display:block}
  input[type=file],select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .btn{display:inline-block;background:var(--btn);color:#222;padding:10px 16px;border-radius:10px;font-weight:800;border:none;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .preview{border:1px solid var(--border);border-radius:12px;overflow:hidden;min-height:220px;display:flex;align-items:center;justify-content:center;background:#fafafa;margin-top:8px}
  .preview img{max-width:100%;height:auto;display:block}
  .note{color:var(--ink-soft);font-size:14px;margin-top:6px}
  .status{margin:10px 0 0;padding:10px;border:1px solid var(--border);border-radius:10px;background:#eef3ff;color:#0b53b3}
  .err{background:#fff5f5;color:#a02020;border-color:#f6c6c6}
  details{margin-top:10px}
  summary{cursor:pointer;font-weight:700}
  code,kbd{background:#f3f4f6;padding:2px 6px;border-radius:6px}
  .radio-row{display:flex;gap:12px;margin-top:6px;align-items:center}
</style>
</head>
<body>
<header>
  <h1>Photobalm AI</h1>
  <p>Restore and enhance portraits with Dzine.ai — private & secure.</p>
</header>

<main class="wrap">
  <!-- RESTORE -->
  <section class="card">
    <h2>Portrait Restoration</h2>
    <div class="row">
      <div class="col">
        <div class="drop" id="drop-restore">
          <input type="file" id="file-restore" accept="image/*" />
          <div><strong>Drag & drop</strong> or click to select (JPG/PNG/WebP)</div>
        </div>
        <label for="r-scale">Upscale while restoring</label>
        <select id="r-scale">
          <option value="2">2× (recommended)</option>
          <option value="1.5">1.5×</option>
          <option value="3">3×</option>
          <option value="4">4×</option>
        </select>

        <div class="radio-row">
          <label><input type="radio" name="quality" value="standard" checked> Standard (fast)</label>
          <label><input type="radio" name="quality" value="high"> High Quality (Dzine IMG2IMG)</label>
        </div>

        <button class="btn" id="run-restore" style="margin-top:10px">Run Restore</button>
        <div id="status-restore" class="status" style="display:none"></div>
      </div>
      <div class="col">
        <div class="preview" id="input-restore">No image</div>
        <div class="preview" id="output-restore" style="margin-top:10px">Result shows here</div>
      </div>
    </div>
    <details>
      <summary>Request / Response log</summary>
      <pre id="log-restore" style="white-space:pre-wrap;font-size:12px"></pre>
    </details>
  </section>

  <!-- UPSCALE -->
  <section class="card">
    <h2>Upscale</h2>
    <div class="row">
      <div class="col">
        <div class="drop" id="drop-upscale">
          <input type="file" id="file-upscale" accept="image/*" />
          <div><strong>Drag & drop</strong> or click to select</div>
        </div>
        <label for="u-scale">Scale</label>
        <select id="u-scale">
          <option value="2">2×</option>
          <option value="3">3×</option>
          <option value="4">4×</option>
        </select>
        <button class="btn" id="run-upscale" style="margin-top:10px">Run Upscale</button>
        <div id="status-upscale" class="status" style="display:none"></div>
      </div>
      <div class="col">
        <div class="preview" id="input-upscale">No image</div>
        <div class="preview" id="output-upscale" style="margin-top:10px">Result shows here</div>
      </div>
    </div>
    <details>
      <summary>Request / Response log</summary>
      <pre id="log-upscale" style="white-space:pre-wrap;font-size:12px"></pre>
    </details>
  </section>

  <section class="card">
    <h3>Auth & Endpoints</h3>
    <div class="note">
      Cloudinary preset: <kbd>photobalm-upload</kbd><br>
      Functions: <code>/.netlify/functions/restore</code>, <code>/.netlify/functions/upscale</code><br>
      (Your Dzine API key stays private on Netlify)
    </div>
  </section>
</main>

<script>
/* ---------- SETTINGS ---------- */
const CLOUDINARY_CLOUD_NAME = 'drqxthmef';
const CLOUDINARY_UPLOAD_PRESET = 'photobalm-upload';

/* ---------- HELPERS ---------- */
const $ = id => document.getElementById(id);
function logLine(pre, ...p){const t=p.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ');pre.textContent+=(pre.textContent?'\n':'')+t;}
function setStatus(el,msg,err=false){el.textContent=msg;el.style.display='block';el.className='status'+(err?' err':'');}
function previewFile(input,prev){prev.innerHTML='No image';const f=input.files&&input.files[0]?input.files[0]:null;if(!f)return null;const u=URL.createObjectURL(f);const i=new Image();i.onload=()=>URL.revokeObjectURL(u);i.src=u;prev.innerHTML='';prev.appendChild(i);return f;}
async function uploadToCloudinary(f){const u=`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;const form=new FormData();form.append('file',f);form.append('upload_preset',CLOUDINARY_UPLOAD_PRESET);const r=await fetch(u,{method:'POST',body:form});if(!r.ok)throw new Error(await r.text());return r.json();}

/* ---------- CALLERS ---------- */
async function callRestore(imageUrl,opts,logEl,statusEl,quality){
  const fn = quality==='high' ? '/.netlify/functions/restore' : '/.netlify/functions/upscale'; // both accept same format now
  logLine(logEl,'POST',fn,{image_url:imageUrl,options:opts});
  const res = await fetch(fn,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image_url:imageUrl,options:opts})});
  if(res.status===202){
    const {task_id}=await res.json();logLine(logEl,'Accepted task_id',task_id);
    setStatus(statusEl,'Processing… (this may take up to 2 min)');
    const start=Date.now();
    while(Date.now()-start<180000){
      await new Promise(r=>setTimeout(r,1500));
      const s=await fetch(`${fn}?task_id=${encodeURIComponent(task_id)}`);
      const j=await s.json().catch(()=>({}));
      logLine(logEl,'GET status',j);
      if(s.ok&&j.processed_url)return j.processed_url;
    }
    throw new Error('Restore still running (timeout).');
  }
  if(res.ok&&res.headers.get('Content-Type')?.includes('application/json')){
    const j=await res.json();if(j.processed_url)return j.processed_url;
  }
  throw new Error(await res.text());
}

async function callUpscale(imageUrl,opts,logEl,statusEl){
  logLine(logEl,'POST /upscale',{image_url:imageUrl,options:opts});
  const res=await fetch('/.netlify/functions/upscale',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image_url:imageUrl,options:opts})});
  if(res.status===202){
    const {task_id}=await res.json();logLine(logEl,'Accepted task_id',task_id);
    setStatus(statusEl,'Processing…');
    const start=Date.now();
    while(Date.now()-start<180000){
      await new Promise(r=>setTimeout(r,1500));
      const s=await fetch(`/.netlify/functions/upscale?task_id=${encodeURIComponent(task_id)}`);
      const j=await s.json().catch(()=>({}));
      logLine(logEl,'GET status',j);
      if(s.ok&&j.processed_url)return j.processed_url;
    }
    throw new Error('Upscale still running (timeout).');
  }
  if(res.ok&&res.headers.get('Content-Type')?.includes('application/json')){
    const j=await res.json();if(j.processed_url)return j.processed_url;
  }
  throw new Error(await res.text());
}

/* ---------- WIRE UI ---------- */
function wireTool(prefix){
  const drop=$(`drop-${prefix}`),input=$(`file-${prefix}`),run=$(`run-${prefix}`),
        inpPrev=$(`input-${prefix}`),outPrev=$(`output-${prefix}`),
        status=$(`status-${prefix}`),log=$(`log-${prefix}`);
  drop.addEventListener('click',()=>input.click());
  input.addEventListener('change',()=>previewFile(input,inpPrev));
  run.addEventListener('click',async()=>{
    try{
      log.textContent='';setStatus(status,'Uploading to Cloudinary…');run.disabled=true;
      const file=previewFile(input,inpPrev);if(!file){setStatus(status,'Choose an image first.',true);run.disabled=false;return;}
      const up=await uploadToCloudinary(file);const imageUrl=up.secure_url;logLine(log,'Cloudinary URL',imageUrl);setStatus(status,'Starting job…');
      let result;
      if(prefix==='restore'){
        const scaleSel=$('r-scale');const upscale=Number(scaleSel.value);
        const quality=document.querySelector('input[name="quality"]:checked').value;
        result=await callRestore(imageUrl,{upscale},log,status,quality);
      }else{
        const scaleSel=$('u-scale');const scale=Number(scaleSel.value);
        result=await callUpscale(imageUrl,{scale},log,status);
      }
      outPrev.innerHTML=`<img alt="Result" src="${result}">`;setStatus(status,'Done!');
    }catch(e){console.error(e);setStatus(status,String(e.message||e),true);alert(`${prefix==='restore'?'Restore':'Upscale'} failed: ${e.message||e}`);}
    finally{run.disabled=false;}
  });
}
wireTool('restore');wireTool('upscale');
</script>
</body>
</html>
