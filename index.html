<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Photobalm AI</title>
<style>
  :root{--ink:#0f172a;--ink-soft:#4b5563;--nav:#122647;--cream:#f7f3ea;--btn:#f6c10e;--border:#e5e7eb;--panel:#fff}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--cream)}
  header{background:var(--nav);color:#fff;padding:28px 16px;text-align:center}
  header h1{margin:0 0 6px;font-size:34px}
  header p{margin:0;color:#d9e1f2}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(15,23,42,.08);padding:18px}
  .card h2{margin:4px 0 10px}
  .row{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap}
  .col{flex:1 1 320px}
  .drop{display:flex;align-items:center;justify-content:center;text-align:center;border:2px dashed #cbd5e1;border-radius:14px;background:#fafaf9;padding:22px;cursor:pointer}
  .drop input{display:none}
  label{font-weight:700;margin:10px 0 6px;display:block}
  input[type=file],select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .btn{display:inline-block;background:var(--btn);color:#222;padding:10px 16px;border-radius:10px;font-weight:800;border:none;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .preview{border:1px solid var(--border);border-radius:12px;overflow:hidden;min-height:220px;display:flex;align-items:center;justify-content:center;background:#fafafa;margin-top:8px}
  .preview img{max-width:100%;height:auto;display:block}
  .note{color:var(--ink-soft);font-size:14px;margin-top:6px}
  .status{margin:10px 0 0;padding:10px;border:1px solid var(--border);border-radius:10px;background:#eef3ff;color:#0b53b3}
  .err{background:#fff5f5;color:#a02020;border-color:#f6c6c6}
  details{margin-top:10px}
  summary{cursor:pointer;font-weight:700}
  code,kbd{background:#f3f4f6;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
  <header>
    <h1>Photobalm AI</h1>
    <p>Restore and enhance portraits with Dzine.ai — private & secure.</p>
  </header>

  <main class="wrap">
    <!-- RESTORE -->
    <section class="card">
      <h2>Portrait Restoration</h2>
      <div class="row">
        <div class="col">
          <div class="drop" id="drop-restore">
            <input type="file" id="file-restore" accept="image/*" />
            <div><strong>Drag & drop</strong> or click to select (JPG/PNG/WebP)</div>
          </div>
          <label for="r-scale">Upscale while restoring</label>
          <select id="r-scale">
            <option value="2">2× (recommended)</option>
            <option value="1.5">1.5×</option>
            <option value="3">3×</option>
            <option value="4">4×</option>
          </select>
          <button class="btn" id="run-restore" style="margin-top:10px">Run Restore</button>
          <div id="status-restore" class="status" style="display:none"></div>
        </div>
        <div class="col">
          <div class="preview" id="input-restore">No image</div>
          <div class="preview" id="output-restore" style="margin-top:10px">Result shows here</div>
        </div>
      </div>
      <details>
        <summary>Request / Response log</summary>
        <pre id="log-restore" style="white-space:pre-wrap;font-size:12px"></pre>
      </details>
    </section>

    <!-- UPSCALE -->
    <section class="card">
      <h2>Upscale</h2>
      <div class="row">
        <div class="col">
          <div class="drop" id="drop-upscale">
            <input type="file" id="file-upscale" accept="image/*" />
            <div><strong>Drag & drop</strong> or click to select</div>
          </div>
          <label for="u-scale">Scale</label>
          <select id="u-scale">
            <option value="2">2×</option>
            <option value="3">3×</option>
            <option value="4">4×</option>
          </select>
          <button class="btn" id="run-upscale" style="margin-top:10px">Run Upscale</button>
          <div id="status-upscale" class="status" style="display:none"></div>
        </div>
        <div class="col">
          <div class="preview" id="input-upscale">No image</div>
          <div class="preview" id="output-upscale" style="margin-top:10px">Result shows here</div>
        </div>
      </div>
      <details>
        <summary>Request / Response log</summary>
        <pre id="log-upscale" style="white-space:pre-wrap;font-size:12px"></pre>
      </details>
    </section>

    <section class="card">
      <h3>Auth & Endpoints</h3>
      <div class="note">
        Cloudinary preset: <kbd>photobalm-upload</kbd><br>
        Functions: <code>/.netlify/functions/restore</code>, <code>/.netlify/functions/upscale</code><br>
        (Your Dzine API key stays private on Netlify)
      </div>
    </section>
  </main>

<script>
/* ---------- SETTINGS (change only if your Cloud name/preset differ) ---------- */
const CLOUDINARY_CLOUD_NAME = 'drqxthmef';
const CLOUDINARY_UPLOAD_PRESET = 'photobalm-upload';

/* ---------- HELPERS ---------- */
const $ = (id) => document.getElementById(id);

function logLine(preEl, ...parts){
  const t = parts.map(x => typeof x === 'string' ? x : JSON.stringify(x, null, 2)).join(' ');
  preEl.textContent += (preEl.textContent ? '\n' : '') + t;
}

function setStatus(el, msg, isErr=false){
  el.textContent = msg;
  el.style.display = 'block';
  el.className = 'status' + (isErr ? ' err' : '');
}

function previewFile(input, previewEl){
  previewEl.innerHTML = 'No image';
  const f = input.files && input.files[0] ? input.files[0] : null;
  if(!f) return null;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.onload = () => URL.revokeObjectURL(url);
  img.src = url;
  previewEl.innerHTML = '';
  previewEl.appendChild(img);
  return f;
}

async function uploadToCloudinary(file){
  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;
  const form = new FormData();
  form.append('file', file);
  form.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
  const res = await fetch(url, { method:'POST', body: form });
  if(!res.ok) throw new Error(await res.text());
  return res.json(); // { secure_url, ... }
}

/* ---------- POLLING-AWARE CALLERS (THIS IS THE PART YOU NEEDED) ---------- */
async function callRestore(imageUrl, opts, logEl, statusEl){
  // Start the job
  logLine(logEl, 'POST /restore', { image_url: imageUrl, options: opts });
  let res = await fetch('/.netlify/functions/restore', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ image_url: imageUrl, options: opts })
  });

  // If function returned final result directly
  if(res.ok && res.headers.get('Content-Type')?.includes('application/json')){
    const j = await res.json();
    if(j.processed_url){
      logLine(logEl, '✓ Result ready (direct)');
      return j.processed_url;
    }
  }

  // If async: 202 with task_id → poll GET ?task_id=...
  if(res.status === 202){
    const j = await res.json();
    const taskId = j.task_id;
    logLine(logEl, 'Accepted, task_id:', taskId);
    setStatus(statusEl, 'Processing… (this can take a bit)');

    const started = Date.now();
    while(Date.now() - started < 180000){ // poll up to 3 minutes
      await new Promise(r => setTimeout(r, 1500));
      const s = await fetch(`/.netlify/functions/restore?task_id=${encodeURIComponent(taskId)}`);
      const sj = await s.json().catch(()=> ({}));
      logLine(logEl, 'GET status', sj);
      if(s.ok && sj.processed_url){
        logLine(logEl, '✓ Result ready (polled)');
        return sj.processed_url;
      }
      // otherwise keep polling
    }
    throw new Error('Restore still running (timeout).');
  }

  // Hard error text
  throw new Error(await res.text());
}

async function callUpscale(imageUrl, opts, logEl, statusEl){
  logLine(logEl, 'POST /upscale', { image_url: imageUrl, options: opts });
  let res = await fetch('/.netlify/functions/upscale', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ image_url: imageUrl, options: opts })
  });

  if(res.ok && res.headers.get('Content-Type')?.includes('application/json')){
    const j = await res.json();
    if(j.processed_url){
      logLine(logEl, '✓ Result ready (direct)');
      return j.processed_url;
    }
  }

  if(res.status === 202){
    const j = await res.json();
    const taskId = j.task_id;
    logLine(logEl, 'Accepted, task_id:', taskId);
    setStatus(statusEl, 'Processing…');

    const started = Date.now();
    while(Date.now() - started < 180000){
      await new Promise(r => setTimeout(r, 1500));
      const s = await fetch(`/.netlify/functions/upscale?task_id=${encodeURIComponent(taskId)}`);
      const sj = await s.json().catch(()=> ({}));
      logLine(logEl, 'GET status', sj);
      if(s.ok && sj.processed_url){
        logLine(logEl, '✓ Result ready (polled)');
        return sj.processed_url;
      }
    }
    throw new Error('Upscale still running (timeout).');
  }

  throw new Error(await res.text());
}

/* ---------- WIRE UI ---------- */
function wireTool(prefix){
  const drop = $(`drop-${prefix}`);
  const input = $(`file-${prefix}`);
  const runBtn = $(`run-${prefix}`);
  const inpPrev = $(`input-${prefix}`);
  const outPrev = $(`output-${prefix}`);
  const statusEl = $(`status-${prefix}`);
  const logEl = $(`log-${prefix}`);

  // clicking the drop area opens file chooser
  drop.addEventListener('click', () => input.click());
  input.addEventListener('change', () => previewFile(input, inpPrev));

  runBtn.addEventListener('click', async () => {
    try{
      logEl.textContent = '';
      setStatus(statusEl, 'Uploading to Cloudinary…');
      runBtn.disabled = true;

      const file = previewFile(input, inpPrev);
      if(!file){ setStatus(statusEl, 'Choose an image first.', true); runBtn.disabled = false; return; }

      // 1) Upload to Cloudinary
      const up = await uploadToCloudinary(file);
      const imageUrl = up.secure_url;
      logLine(logEl, 'Cloudinary URL', imageUrl);
      setStatus(statusEl, 'Starting job…');

      // 2) Call function (with polling)
      let resultUrl;
      if(prefix === 'restore'){
        const scaleSel = $('r-scale'); const upscale = Number(scaleSel.value);
        resultUrl = await callRestore(imageUrl, { upscale }, logEl, statusEl);
      } else {
        const scaleSel = $('u-scale'); const scale = Number(scaleSel.value);
        resultUrl = await callUpscale(imageUrl, { scale }, logEl, statusEl);
      }

      // 3) Show result
      outPrev.innerHTML = `<img alt="Result" src="${resultUrl}">`;
      setStatus(statusEl, 'Done!');
    }catch(e){
      console.error(e);
      setStatus(statusEl, String(e.message || e), true);
      alert((prefix === 'restore' ? 'Restore' : 'Upscale') + ' failed: ' + (e.message || e));
    }finally{
      runBtn.disabled = false;
    }
  });
}

wireTool('restore');
wireTool('upscale');
</script>
</body>
</html>
